{% extends "layouts/auth_layout.html" %}

{% block title %}PofuAI | Şifre Sıfırla{% endblock %}

{% block marketing_title %}Yeni Şifre Belirleyin{% endblock %}
{% block marketing_subtitle %}Güçlü bir şifre seçerek hesabınızı koruyun{% endblock %}

{% block auth_form %}
<!-- Header -->
<div class="auth-header mb-4">
    <div class="icon-wrapper mb-3">
        <div class="auth-icon success">
            <i class="bi bi-shield-lock-fill"></i>
        </div>
    </div>
    <h1 class="auth-title">Yeni Şifre Oluştur</h1>
    <p class="auth-subtitle">
        Hesabınız için yeni bir şifre belirleyin
    </p>
</div>

<!-- Reset Password Form -->
<form class="auth-form" method="POST" action="/auth/reset-password" id="resetPasswordForm">
    <input type="hidden" name="token" value="{{ token }}">
    
    <!-- New Password -->
    <div class="form-group">
        <label for="password" class="form-label">Yeni Şifre</label>
        <div class="input-group">
            <i class="bi bi-lock input-icon-left"></i>
            <input 
                type="password" 
                class="form-control with-icon-left" 
                id="password" 
                name="password" 
                placeholder="••••••••" 
                required
                autocomplete="new-password"
                minlength="8"
            >
            <span class="input-group-text">
                <i class="bi bi-eye-slash-fill"></i>
            </span>
        </div>
        <!-- Password Strength Meter will be added here by JS -->
    </div>

    <!-- Confirm Password -->
    <div class="form-group">
        <label for="confirmPassword" class="form-label">Şifre Tekrar</label>
        <div class="input-group">
            <i class="bi bi-lock-fill input-icon-left"></i>
            <input 
                type="password" 
                class="form-control with-icon-left" 
                id="confirmPassword" 
                name="password_confirm" 
                placeholder="••••••••" 
                required
                autocomplete="new-password"
            >
            <span class="input-group-text">
                <i class="bi bi-eye-slash-fill"></i>
            </span>
        </div>
        <div class="validation-message"></div>
    </div>

    <!-- Password Requirements -->
    <div class="password-requirements-card">
        <h6 class="requirements-title">
            <i class="bi bi-info-circle"></i>
            Şifre Gereksinimleri
        </h6>
        <ul class="requirements-list">
            <li data-requirement="length">
                <i class="bi bi-circle"></i>
                En az 8 karakter
            </li>
            <li data-requirement="uppercase">
                <i class="bi bi-circle"></i>
                En az bir büyük harf (A-Z)
            </li>
            <li data-requirement="lowercase">
                <i class="bi bi-circle"></i>
                En az bir küçük harf (a-z)
            </li>
            <li data-requirement="number">
                <i class="bi bi-circle"></i>
                En az bir rakam (0-9)
            </li>
            <li data-requirement="special">
                <i class="bi bi-circle"></i>
                En az bir özel karakter (!@#$%^&*)
            </li>
        </ul>
    </div>

    <!-- Submit Button -->
    <button type="submit" class="btn btn-primary btn-block" id="submitBtn" disabled>
        <i class="bi bi-check-circle"></i>
        Şifreyi Güncelle
    </button>

    <!-- Back to Login -->
    <div class="text-center mt-4">
        <a href="/auth/login" class="auth-link">
            <i class="bi bi-arrow-left"></i>
            Giriş sayfasına dön
        </a>
    </div>
</form>

<!-- Security Tips -->
<div class="security-tips mt-5">
    <div class="tips-card">
        <h6 class="tips-title">
            <i class="bi bi-lightbulb"></i>
            Güvenlik İpuçları
        </h6>
        <ul class="tips-list">
            <li>Şifrenizi kimseyle paylaşmayın</li>
            <li>Farklı siteler için farklı şifreler kullanın</li>
            <li>Şifrenizi düzenli olarak güncelleyin</li>
            <li>İki faktörlü doğrulamayı etkinleştirin</li>
        </ul>
    </div>
</div>

<style>
.auth-icon.success {
    background: linear-gradient(135deg, var(--success-color), #059669);
}

.auth-icon {
    width: 80px;
    height: 80px;
    margin: 0 auto;
    background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 36px;
    box-shadow: 0 10px 30px rgba(99, 102, 241, 0.3);
}

.password-requirements-card {
    background: var(--gray-50);
    border-radius: 12px;
    padding: 20px;
    margin: 20px 0;
}

.requirements-title {
    font-size: 14px;
    font-weight: 600;
    color: var(--gray-700);
    margin-bottom: 15px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.requirements-list {
    list-style: none;
    padding: 0;
    margin: 0;
}

.requirements-list li {
    padding: 8px 0;
    color: var(--gray-600);
    font-size: 13px;
    display: flex;
    align-items: center;
    gap: 10px;
    transition: var(--transition);
}

.requirements-list li i {
    font-size: 10px;
    color: var(--gray-400);
    transition: var(--transition);
}

.requirements-list li.valid {
    color: var(--success-color);
}

.requirements-list li.valid i {
    color: var(--success-color);
}

.requirements-list li.valid i::before {
    content: "\F26E"; /* bi-check-circle-fill */
}

.security-tips {
    padding-top: 30px;
    border-top: 1px solid var(--gray-200);
}

.tips-card {
    background: linear-gradient(135deg, #fef3c7, #fde68a);
    border-radius: 12px;
    padding: 20px;
    border: 1px solid #fbbf24;
}

.tips-title {
    font-size: 14px;
    font-weight: 600;
    color: var(--gray-800);
    margin-bottom: 15px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.tips-list {
    list-style: none;
    padding: 0;
    margin: 0;
}

.tips-list li {
    padding: 6px 0;
    color: var(--gray-700);
    font-size: 13px;
    position: relative;
    padding-left: 20px;
}

.tips-list li:before {
    content: "✓";
    position: absolute;
    left: 0;
    color: #f59e0b;
    font-weight: bold;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('resetPasswordForm');
    const passwordInput = document.getElementById('password');
    const confirmPasswordInput = document.getElementById('confirmPassword');
    const submitBtn = document.getElementById('submitBtn');
    const requirements = {
        length: false,
        uppercase: false,
        lowercase: false,
        number: false,
        special: false
    };
    
    // Password validation
    passwordInput.addEventListener('input', function() {
        const password = this.value;
        
        // Check requirements
        requirements.length = password.length >= 8;
        requirements.uppercase = /[A-Z]/.test(password);
        requirements.lowercase = /[a-z]/.test(password);
        requirements.number = /\d/.test(password);
        requirements.special = /[@$!%*?&]/.test(password);
        
        // Update UI
        updateRequirements();
        
        // Check if passwords match
        checkPasswordMatch();
        
        // Enable/disable submit button
        updateSubmitButton();
    });
    
    // Confirm password validation
    confirmPasswordInput.addEventListener('input', function() {
        checkPasswordMatch();
        updateSubmitButton();
    });
    
    // Update requirements UI
    function updateRequirements() {
        Object.keys(requirements).forEach(req => {
            const element = document.querySelector(`[data-requirement="${req}"]`);
            if (element) {
                if (requirements[req]) {
                    element.classList.add('valid');
                } else {
                    element.classList.remove('valid');
                }
            }
        });
    }
    
    // Check if passwords match
    function checkPasswordMatch() {
        const validationMessage = confirmPasswordInput.parentElement.parentElement.querySelector('.validation-message');
        
        if (confirmPasswordInput.value && passwordInput.value !== confirmPasswordInput.value) {
            confirmPasswordInput.classList.add('is-invalid');
            confirmPasswordInput.classList.remove('is-valid');
            validationMessage.innerHTML = '<i class="bi bi-x-circle"></i> Şifreler eşleşmiyor';
            validationMessage.className = 'validation-message error';
            return false;
        } else if (confirmPasswordInput.value && passwordInput.value === confirmPasswordInput.value) {
            confirmPasswordInput.classList.remove('is-invalid');
            confirmPasswordInput.classList.add('is-valid');
            validationMessage.innerHTML = '<i class="bi bi-check-circle"></i> Şifreler eşleşiyor';
            validationMessage.className = 'validation-message success';
            return true;
        } else {
            confirmPasswordInput.classList.remove('is-invalid', 'is-valid');
            validationMessage.innerHTML = '';
            return false;
        }
    }
    
    // Update submit button state
    function updateSubmitButton() {
        const allRequirementsMet = Object.values(requirements).every(req => req === true);
        const passwordsMatch = passwordInput.value === confirmPasswordInput.value && confirmPasswordInput.value !== '';
        
        if (allRequirementsMet && passwordsMatch) {
            submitBtn.disabled = false;
            submitBtn.classList.remove('opacity-50');
        } else {
            submitBtn.disabled = true;
            submitBtn.classList.add('opacity-50');
        }
    }
    
    // Handle form submission
    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        // Final validation
        if (!Object.values(requirements).every(req => req === true)) {
            AuthModern.showToast('Lütfen tüm şifre gereksinimlerini karşılayın', 'error');
            return;
        }
        
        if (passwordInput.value !== confirmPasswordInput.value) {
            AuthModern.showToast('Şifreler eşleşmiyor', 'error');
            return;
        }
        
        // Show loading state
        submitBtn.disabled = true;
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<span class="spinner"></span> Güncelleniyor...';
        
        // Simulate API call
        setTimeout(() => {
            // Show success message
            AuthModern.showToast('Şifreniz başarıyla güncellendi!', 'success');
            
            // Show success state
            showSuccessState();
            
            // Redirect to login after delay
            setTimeout(() => {
                window.location.href = '/auth/login';
            }, 3000);
        }, 2000);
    });
    
    // Show success state
    function showSuccessState() {
        // Create success message
        const successDiv = document.createElement('div');
        successDiv.className = 'success-state mt-4 animate__animated animate__fadeIn';
        successDiv.innerHTML = `
            <div class="success-card">
                <div class="success-icon">
                    <i class="bi bi-check-circle-fill text-success"></i>
                </div>
                <h5>Şifre Güncellendi!</h5>
                <p class="mb-2">Şifreniz başarıyla güncellendi.</p>
                <p class="text-muted small">Giriş sayfasına yönlendiriliyorsunuz...</p>
                <div class="progress mt-3" style="height: 4px;">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%"></div>
                </div>
            </div>
        `;
        
        // Replace form with success message
        form.style.display = 'none';
        form.parentElement.insertBefore(successDiv, form.nextSibling);
    }
});
</script>

<style>
.success-card {
    background: linear-gradient(135deg, #f0fdf4, #dcfce7);
    border: 2px solid var(--success-color);
    border-radius: 12px;
    padding: 30px;
    text-align: center;
}

.success-icon {
    font-size: 48px;
    margin-bottom: 15px;
}

.success-card h5 {
    color: var(--gray-800);
    margin-bottom: 15px;
}

.success-card p {
    color: var(--gray-600);
}

.opacity-50 {
    opacity: 0.5;
}
</style>
{% endblock %} 